USE [DSSCM]
GO
/****** Object:  StoredProcedure [dbo].[MySCM_WeekAndOutPlan]    Script Date: 2018/9/20 11:36:37 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<shenxin>
-- Create date: <20180920>
-- Description:	<集团化供应商采购周计划（采购+委外）>
-- =============================================
ALTER PROCEDURE [dbo].[Group_WeekAndOutPlan]
	@LoginID VARCHAR(20),
	@iCodeID VARCHAR(20)

AS

BEGIN
	SELECT
		TD004 AS TA006,
		TD001+'-'+TD002+'-'+TD003 AS newNo,--采购单号
		ROUND(TD008,0)  AS StockQuantity,--采购数量
		TD015 AS CommitQuantity,--已交数量
		ISNULL(SUMTH015,'0') AS NoCheckQuantity,--待检数量
		CAST(TD008-TD015-CAST(ISNULL(SUMTH015,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
		TD013+'-'+TD021 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TC004 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TD004 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(PURTD.UDF01,1,4)+'-'+SUBSTRING(PURTD.UDF01,5,2)+'-'+SUBSTRING(PURTD.UDF01,7,2) AS TA009,--预交货开始日期
		SUBSTRING(TD012,1,4)+'-'+SUBSTRING(TD012,5,2)+'-'+SUBSTRING(TD012,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA012, --预开工日期
		PURTD.UDF04 AS ZHOU,--周次
		PURTD.UDF07 AS UDF07--配件客户
	FROM DS2010..PURTD AS PURTD
		INNER JOIN DS2010..INVMB ON MB001=TD004
		INNER JOIN DS2010..PURTC AS PURTC ON TC001=TD001 AND TC002=TD002
		LEFT JOIN DS2010..PURMA ON MA001=TC004
		LEFT JOIN (SELECT TH011,TH012,TH013,SUM(TH007) AS SUMTH015 FROM DS2010..PURTH WHERE TH030='N' GROUP BY TH011,TH012,TH013) AS PURTHDATE
		ON PURTHDATE.TH011=PURTD.TD001 AND PURTHDATE.TH012=PURTD.TD002 AND PURTHDATE.TH013=PURTD.TD003
		LEFT JOIN DS2010..MOCTA ON TD013=TA001 AND TD021=TA002
	WHERE TC014='Y' AND TD016='N' AND PURTD.UDF02='Y' AND TC004=@LoginID AND TA006 IS NOT NULL
    UNION
  SELECT
		TD004 AS TA006,
		TD001+'-'+TD002+'-'+TD003 AS newNo,--采购单号
		ROUND(TD008,0)  AS StockQuantity,--采购数量
		TD015 AS CommitQuantity,--已交数量
		ISNULL(SUMTH015,'0') AS NoCheckQuantity,--待检数量
		CAST(TD008-TD015-CAST(ISNULL(SUMTH015,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
		TD013+'-'+TD021 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TC004 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TD004 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(PURTD.UDF01,1,4)+'-'+SUBSTRING(PURTD.UDF01,5,2)+'-'+SUBSTRING(PURTD.UDF01,7,2) AS TA009,--预交货开始日期
		SUBSTRING(TD012,1,4)+'-'+SUBSTRING(TD012,5,2)+'-'+SUBSTRING(TD012,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA012, --预开工日期
		PURTD.UDF04 AS ZHOU,--周次
		PURTD.UDF07 AS UDF07--配件客户
	FROM DS2018..PURTD AS PURTD
		INNER JOIN DS2018..INVMB ON MB001=TD004
		INNER JOIN DS2018..PURTC AS PURTC ON TC001=TD001 AND TC002=TD002
		LEFT JOIN DS2018..PURMA ON MA001=TC004
		LEFT JOIN (SELECT TH011,TH012,TH013,SUM(TH007) AS SUMTH015 FROM DS2018..PURTH WHERE TH030='N' GROUP BY TH011,TH012,TH013) AS PURTHDATE
		ON PURTHDATE.TH011=PURTD.TD001 AND PURTHDATE.TH012=PURTD.TD002 AND PURTHDATE.TH013=PURTD.TD003
		LEFT JOIN DS2018..MOCTA ON TD013=TA001 AND TD021=TA002
	WHERE TC014='Y' AND TD016='N' AND PURTD.UDF02='Y' AND TC004=@LoginID AND TA006 IS NOT NULL
    UNION
  SELECT
		TD004 AS TA006,
		TD001+'-'+TD002+'-'+TD003 AS newNo,--采购单号
		ROUND(TD008,0)  AS StockQuantity,--采购数量
		TD015 AS CommitQuantity,--已交数量
		ISNULL(SUMTH015,'0') AS NoCheckQuantity,--待检数量
		CAST(TD008-TD015-CAST(ISNULL(SUMTH015,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
		TD013+'-'+TD021 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TC004 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TD004 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(PURTD.UDF01,1,4)+'-'+SUBSTRING(PURTD.UDF01,5,2)+'-'+SUBSTRING(PURTD.UDF01,7,2) AS TA009,--预交货开始日期
		SUBSTRING(TD012,1,4)+'-'+SUBSTRING(TD012,5,2)+'-'+SUBSTRING(TD012,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA012, --预开工日期
		PURTD.UDF04 AS ZHOU,--周次
		PURTD.UDF07 AS UDF07--配件客户
	FROM DS201803..PURTD AS PURTD
		INNER JOIN DS201803..INVMB ON MB001=TD004
		INNER JOIN DS201803..PURTC AS PURTC ON TC001=TD001 AND TC002=TD002
		LEFT JOIN DS201803..PURMA ON MA001=TC004
		LEFT JOIN (SELECT TH011,TH012,TH013,SUM(TH007) AS SUMTH015 FROM DS201803..PURTH WHERE TH030='N' GROUP BY TH011,TH012,TH013) AS PURTHDATE
		ON PURTHDATE.TH011=PURTD.TD001 AND PURTHDATE.TH012=PURTD.TD002 AND PURTHDATE.TH013=PURTD.TD003
		LEFT JOIN DS201803..MOCTA ON TD013=TA001 AND TD021=TA002
	WHERE TC014='Y' AND TD016='N' AND PURTD.UDF02='Y' AND TC004=@LoginID AND TA006 IS NOT NULL
    UNION
  SELECT
		TD004 AS TA006,
		TD001+'-'+TD002+'-'+TD003 AS newNo,--采购单号
		ROUND(TD008,0)  AS StockQuantity,--采购数量
		TD015 AS CommitQuantity,--已交数量
		ISNULL(SUMTH015,'0') AS NoCheckQuantity,--待检数量
		CAST(TD008-TD015-CAST(ISNULL(SUMTH015,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
		TD013+'-'+TD021 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TC004 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TD004 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(PURTD.UDF01,1,4)+'-'+SUBSTRING(PURTD.UDF01,5,2)+'-'+SUBSTRING(PURTD.UDF01,7,2) AS TA009,--预交货开始日期
		SUBSTRING(TD012,1,4)+'-'+SUBSTRING(TD012,5,2)+'-'+SUBSTRING(TD012,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA012, --预开工日期
		PURTD.UDF04 AS ZHOU,--周次
		PURTD.UDF07 AS UDF07--配件客户
	FROM DS201805..PURTD AS PURTD
		INNER JOIN DS201805..INVMB ON MB001=TD004
		INNER JOIN DS201805..PURTC AS PURTC ON TC001=TD001 AND TC002=TD002
		LEFT JOIN DS201805..PURMA ON MA001=TC004
		LEFT JOIN (SELECT TH011,TH012,TH013,SUM(TH007) AS SUMTH015 FROM DS201805..PURTH WHERE TH030='N' GROUP BY TH011,TH012,TH013) AS PURTHDATE
		ON PURTHDATE.TH011=PURTD.TD001 AND PURTHDATE.TH012=PURTD.TD002 AND PURTHDATE.TH013=PURTD.TD003
		LEFT JOIN DS201805..MOCTA ON TD013=TA001 AND TD021=TA002
	WHERE TC014='Y' AND TD016='N' AND PURTD.UDF02='Y' AND TC004=@LoginID AND TA006 IS NOT NULL
    UNION
  SELECT
		TD004 AS TA006,
		TD001+'-'+TD002+'-'+TD003 AS newNo,--采购单号
		ROUND(TD008,0)  AS StockQuantity,--采购数量
		TD015 AS CommitQuantity,--已交数量
		ISNULL(SUMTH015,'0') AS NoCheckQuantity,--待检数量
		CAST(TD008-TD015-CAST(ISNULL(SUMTH015,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
		TD013+'-'+TD021 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TC004 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TD004 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(PURTD.UDF01,1,4)+'-'+SUBSTRING(PURTD.UDF01,5,2)+'-'+SUBSTRING(PURTD.UDF01,7,2) AS TA009,--预交货开始日期
		SUBSTRING(TD012,1,4)+'-'+SUBSTRING(TD012,5,2)+'-'+SUBSTRING(TD012,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA012, --预开工日期
		PURTD.UDF04 AS ZHOU,--周次
		PURTD.UDF07 AS UDF07--配件客户
	FROM DS201808..PURTD AS PURTD
		INNER JOIN DS201808..INVMB ON MB001=TD004
		INNER JOIN DS201808..PURTC AS PURTC ON TC001=TD001 AND TC002=TD002
		LEFT JOIN DS201808..PURMA ON MA001=TC004
		LEFT JOIN (SELECT TH011,TH012,TH013,SUM(TH007) AS SUMTH015 FROM DS201808..PURTH WHERE TH030='N' GROUP BY TH011,TH012,TH013) AS PURTHDATE
		ON PURTHDATE.TH011=PURTD.TD001 AND PURTHDATE.TH012=PURTD.TD002 AND PURTHDATE.TH013=PURTD.TD003
		LEFT JOIN DS201808..MOCTA ON TD013=TA001 AND TD021=TA002
	WHERE TC014='Y' AND TD016='N' AND PURTD.UDF02='Y' AND TC004=@LoginID AND TA006 IS NOT NULL
    UNION
  SELECT
		TD004 AS TA006,
		TD001+'-'+TD002+'-'+TD003 AS newNo,--采购单号
		ROUND(TD008,0)  AS StockQuantity,--采购数量
		TD015 AS CommitQuantity,--已交数量
		ISNULL(SUMTH015,'0') AS NoCheckQuantity,--待检数量
		CAST(TD008-TD015-CAST(ISNULL(SUMTH015,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
		TD013+'-'+TD021 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TC004 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TD004 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(PURTD.UDF01,1,4)+'-'+SUBSTRING(PURTD.UDF01,5,2)+'-'+SUBSTRING(PURTD.UDF01,7,2) AS TA009,--预交货开始日期
		SUBSTRING(TD012,1,4)+'-'+SUBSTRING(TD012,5,2)+'-'+SUBSTRING(TD012,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA012, --预开工日期
		PURTD.UDF04 AS ZHOU,--周次
		PURTD.UDF07 AS UDF07--配件客户
	FROM DS201810..PURTD AS PURTD
		INNER JOIN DS201810..INVMB ON MB001=TD004
		INNER JOIN DS201810..PURTC AS PURTC ON TC001=TD001 AND TC002=TD002
		LEFT JOIN DS201810..PURMA ON MA001=TC004
		LEFT JOIN (SELECT TH011,TH012,TH013,SUM(TH007) AS SUMTH015 FROM DS201810..PURTH WHERE TH030='N' GROUP BY TH011,TH012,TH013) AS PURTHDATE
		ON PURTHDATE.TH011=PURTD.TD001 AND PURTHDATE.TH012=PURTD.TD002 AND PURTHDATE.TH013=PURTD.TD003
		LEFT JOIN DS201810..MOCTA ON TD013=TA001 AND TD021=TA002
	WHERE TC014='Y' AND TD016='N' AND PURTD.UDF02='Y' AND TC004=@LoginID AND TA006 IS NOT NULL

	UNION

  SELECT
		TA006,
		TA001+'-'+TA002 AS newNo,--采购单号
		TA015 AS StockQuantity,--采购数量
		TA017 AS CommitQuantity,--已交数量,
		ISNULL(SUMTI007,'0') AS NoCheckQuantity,--待检数量
		CAST(TA015-TA017-CAST(ISNULL(SUMTI007,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
	    TA024+'-'+TA025 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TA032 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TA006 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA009, --预交货开始日期
		SUBSTRING(TA010,1,4)+'-'+SUBSTRING(TA010,5,2)+'-'+SUBSTRING(TA010,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TO009,1,4)+'-'+SUBSTRING(TO009,5,2)+'-'+SUBSTRING(TO009,7,2) AS TA012,--预开工日期
		MOCTA.UDF03 AS ZHOU, --周次
		MOCTA.UDF07 UDF07--配件客户
	FROM DS2010..MOCTA AS MOCTA
		INNER JOIN DS2010..INVMB ON MB001 = TA006
		LEFT JOIN DS2010..PURMA ON MA001 = TA032
		LEFT JOIN DS2010..MOCTG ON TG014 = TA001 AND TG015 = TA002
		LEFT JOIN (SELECT TI013,TI014,SUM(TI007) AS SUMTI007 FROM DS2010..MOCTI WHERE TI037='N' GROUP BY TI013,TI014) AS PURTHDATE
		ON PURTHDATE.TI013=MOCTA.TA001 AND PURTHDATE.TI014=MOCTA.TA002
		LEFT JOIN  (select TA001 TO001,TA002 TO002,TA009 TO009 FROM  DS2010..MOCTA WHERE TA011='1' AND UDF02 = 'Y') AS B ON TA024=TO001 AND TA025=TO002
	WHERE TA011 IN ('1','2','3') AND TA013 = 'Y' AND MOCTA.UDF02 = 'Y' AND TA032=@LoginID AND TA006 IS NOT NULL
	  UNION
  SELECT
		TA006,
		TA001+'-'+TA002 AS newNo,--采购单号
		TA015 AS StockQuantity,--采购数量
		TA017 AS CommitQuantity,--已交数量,
		ISNULL(SUMTI007,'0') AS NoCheckQuantity,--待检数量
		CAST(TA015-TA017-CAST(ISNULL(SUMTI007,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
	    TA024+'-'+TA025 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TA032 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TA006 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA009, --预交货开始日期
		SUBSTRING(TA010,1,4)+'-'+SUBSTRING(TA010,5,2)+'-'+SUBSTRING(TA010,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TO009,1,4)+'-'+SUBSTRING(TO009,5,2)+'-'+SUBSTRING(TO009,7,2) AS TA012,--预开工日期
		MOCTA.UDF03 AS ZHOU, --周次
		MOCTA.UDF07 UDF07--配件客户
	FROM DS2018..MOCTA AS MOCTA
		INNER JOIN DS2018..INVMB ON MB001 = TA006
		LEFT JOIN DS2018..PURMA ON MA001 = TA032
		LEFT JOIN DS2018..MOCTG ON TG014 = TA001 AND TG015 = TA002
		LEFT JOIN (SELECT TI013,TI014,SUM(TI007) AS SUMTI007 FROM DS2018..MOCTI WHERE TI037='N' GROUP BY TI013,TI014) AS PURTHDATE
		ON PURTHDATE.TI013=MOCTA.TA001 AND PURTHDATE.TI014=MOCTA.TA002
		LEFT JOIN  (select TA001 TO001,TA002 TO002,TA009 TO009 FROM  DS2018..MOCTA WHERE TA011='1' AND UDF02 = 'Y') AS B ON TA024=TO001 AND TA025=TO002
	WHERE TA011 IN ('1','2','3') AND TA013 = 'Y' AND MOCTA.UDF02 = 'Y' AND TA032=@LoginID AND TA006 IS NOT NULL
	  UNION
  SELECT
		TA006,
		TA001+'-'+TA002 AS newNo,--采购单号
		TA015 AS StockQuantity,--采购数量
		TA017 AS CommitQuantity,--已交数量,
		ISNULL(SUMTI007,'0') AS NoCheckQuantity,--待检数量
		CAST(TA015-TA017-CAST(ISNULL(SUMTI007,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
	    TA024+'-'+TA025 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TA032 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TA006 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA009, --预交货开始日期
		SUBSTRING(TA010,1,4)+'-'+SUBSTRING(TA010,5,2)+'-'+SUBSTRING(TA010,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TO009,1,4)+'-'+SUBSTRING(TO009,5,2)+'-'+SUBSTRING(TO009,7,2) AS TA012,--预开工日期
		MOCTA.UDF03 AS ZHOU, --周次
		MOCTA.UDF07 UDF07--配件客户
	FROM DS201803..MOCTA AS MOCTA
		INNER JOIN DS201803..INVMB ON MB001 = TA006
		LEFT JOIN DS201803..PURMA ON MA001 = TA032
		LEFT JOIN DS201803..MOCTG ON TG014 = TA001 AND TG015 = TA002
		LEFT JOIN (SELECT TI013,TI014,SUM(TI007) AS SUMTI007 FROM DS201803..MOCTI WHERE TI037='N' GROUP BY TI013,TI014) AS PURTHDATE
		ON PURTHDATE.TI013=MOCTA.TA001 AND PURTHDATE.TI014=MOCTA.TA002
		LEFT JOIN  (select TA001 TO001,TA002 TO002,TA009 TO009 FROM  DS201803..MOCTA WHERE TA011='1' AND UDF02 = 'Y') AS B ON TA024=TO001 AND TA025=TO002
	WHERE TA011 IN ('1','2','3') AND TA013 = 'Y' AND MOCTA.UDF02 = 'Y' AND TA032=@LoginID AND TA006 IS NOT NULL
	  UNION
  SELECT
		TA006,
		TA001+'-'+TA002 AS newNo,--采购单号
		TA015 AS StockQuantity,--采购数量
		TA017 AS CommitQuantity,--已交数量,
		ISNULL(SUMTI007,'0') AS NoCheckQuantity,--待检数量
		CAST(TA015-TA017-CAST(ISNULL(SUMTI007,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
	    TA024+'-'+TA025 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TA032 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TA006 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA009, --预交货开始日期
		SUBSTRING(TA010,1,4)+'-'+SUBSTRING(TA010,5,2)+'-'+SUBSTRING(TA010,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TO009,1,4)+'-'+SUBSTRING(TO009,5,2)+'-'+SUBSTRING(TO009,7,2) AS TA012,--预开工日期
		MOCTA.UDF03 AS ZHOU, --周次
		MOCTA.UDF07 UDF07--配件客户
	FROM DS201805..MOCTA AS MOCTA
		INNER JOIN DS201805..INVMB ON MB001 = TA006
		LEFT JOIN DS201805..PURMA ON MA001 = TA032
		LEFT JOIN DS201805..MOCTG ON TG014 = TA001 AND TG015 = TA002
		LEFT JOIN (SELECT TI013,TI014,SUM(TI007) AS SUMTI007 FROM DS201805..MOCTI WHERE TI037='N' GROUP BY TI013,TI014) AS PURTHDATE
		ON PURTHDATE.TI013=MOCTA.TA001 AND PURTHDATE.TI014=MOCTA.TA002
		LEFT JOIN  (select TA001 TO001,TA002 TO002,TA009 TO009 FROM  DS201805..MOCTA WHERE TA011='1' AND UDF02 = 'Y') AS B ON TA024=TO001 AND TA025=TO002
	WHERE TA011 IN ('1','2','3') AND TA013 = 'Y' AND MOCTA.UDF02 = 'Y' AND TA032=@LoginID AND TA006 IS NOT NULL
	  UNION
  SELECT
		TA006,
		TA001+'-'+TA002 AS newNo,--采购单号
		TA015 AS StockQuantity,--采购数量
		TA017 AS CommitQuantity,--已交数量,
		ISNULL(SUMTI007,'0') AS NoCheckQuantity,--待检数量
		CAST(TA015-TA017-CAST(ISNULL(SUMTI007,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
	    TA024+'-'+TA025 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TA032 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TA006 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA009, --预交货开始日期
		SUBSTRING(TA010,1,4)+'-'+SUBSTRING(TA010,5,2)+'-'+SUBSTRING(TA010,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TO009,1,4)+'-'+SUBSTRING(TO009,5,2)+'-'+SUBSTRING(TO009,7,2) AS TA012,--预开工日期
		MOCTA.UDF03 AS ZHOU, --周次
		MOCTA.UDF07 UDF07--配件客户
	FROM DS201808..MOCTA AS MOCTA
		INNER JOIN DS201808..INVMB ON MB001 = TA006
		LEFT JOIN DS201808..PURMA ON MA001 = TA032
		LEFT JOIN DS201808..MOCTG ON TG014 = TA001 AND TG015 = TA002
		LEFT JOIN (SELECT TI013,TI014,SUM(TI007) AS SUMTI007 FROM DS201808..MOCTI WHERE TI037='N' GROUP BY TI013,TI014) AS PURTHDATE
		ON PURTHDATE.TI013=MOCTA.TA001 AND PURTHDATE.TI014=MOCTA.TA002
		LEFT JOIN  (select TA001 TO001,TA002 TO002,TA009 TO009 FROM  DS201808..MOCTA WHERE TA011='1' AND UDF02 = 'Y') AS B ON TA024=TO001 AND TA025=TO002
	WHERE TA011 IN ('1','2','3') AND TA013 = 'Y' AND MOCTA.UDF02 = 'Y' AND TA032=@LoginID AND TA006 IS NOT NULL
	  UNION
  SELECT
		TA006,
		TA001+'-'+TA002 AS newNo,--采购单号
		TA015 AS StockQuantity,--采购数量
		TA017 AS CommitQuantity,--已交数量,
		ISNULL(SUMTI007,'0') AS NoCheckQuantity,--待检数量
		CAST(TA015-TA017-CAST(ISNULL(SUMTI007,'0') AS INT) AS INT) AS NoCommitQuantity,--未交数量
	    TA024+'-'+TA025 AS originalNo,--源工单单号
		SUBSTRING(TA003,1,4)+'-'+SUBSTRING(TA003,5,2)+'-'+SUBSTRING(TA003,7,2) AS TA003, --单据日期
		TA032 AS supplierNo,--供应商编号
		MA002 AS supplierName,--供应商名称
		TA006 AS productNo,--品号
		MB002,--品名
		MB003,--规格
		MB004,--单位
		TA015,--预计产量
		SUBSTRING(TA009,1,4)+'-'+SUBSTRING(TA009,5,2)+'-'+SUBSTRING(TA009,7,2) AS TA009, --预交货开始日期
		SUBSTRING(TA010,1,4)+'-'+SUBSTRING(TA010,5,2)+'-'+SUBSTRING(TA010,7,2) AS TA010,--预交货截至日期
		SUBSTRING(TO009,1,4)+'-'+SUBSTRING(TO009,5,2)+'-'+SUBSTRING(TO009,7,2) AS TA012,--预开工日期
		MOCTA.UDF03 AS ZHOU, --周次
		MOCTA.UDF07 UDF07--配件客户
	FROM DS201810..MOCTA AS MOCTA
		INNER JOIN DS201810..INVMB ON MB001 = TA006
		LEFT JOIN DS201810..PURMA ON MA001 = TA032
		LEFT JOIN DS201810..MOCTG ON TG014 = TA001 AND TG015 = TA002
		LEFT JOIN (SELECT TI013,TI014,SUM(TI007) AS SUMTI007 FROM DS201810..MOCTI WHERE TI037='N' GROUP BY TI013,TI014) AS PURTHDATE
		ON PURTHDATE.TI013=MOCTA.TA001 AND PURTHDATE.TI014=MOCTA.TA002
		LEFT JOIN  (select TA001 TO001,TA002 TO002,TA009 TO009 FROM  DS201810..MOCTA WHERE TA011='1' AND UDF02 = 'Y') AS B ON TA024=TO001 AND TA025=TO002
	WHERE TA011 IN ('1','2','3') AND TA013 = 'Y' AND MOCTA.UDF02 = 'Y' AND TA032=@LoginID AND TA006 IS NOT NULL
END