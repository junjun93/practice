USE [DSSCM]
GO
/****** Object:  StoredProcedure [dbo].[MonthsPlanSum]    Script Date: 2018/9/12 9:11:05 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		fangjunjun
-- Create date: 20180808
-- Description:	集团化月计划汇总查询（采购员）
-- =============================================
ALTER PROCEDURE [dbo].[MonthsPlanSum]
	@LOGINID VARCHAR(20),
	@iSupplier VARCHAR(20)

AS
BEGIN

IF @iSupplier IS NULL OR @iSupplier=''
BEGIN
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS2010..PURTD
		INNER JOIN DS2010..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS2010..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS2010..PURMA AS PURMA ON MA001 = TC004
	GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS2018..PURTD
		INNER JOIN DS2018..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS2018..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS2018..PURMA AS PURMA ON MA001 = TC004
	GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS201803..PURTD
		INNER JOIN DS201803..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS201803..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS201803..PURMA AS PURMA ON MA001 = TC004
    GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS201805..PURTD
		INNER JOIN DS201805..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS201805..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS201805..PURMA AS PURMA ON MA001 = TC004
    GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS201808..PURTD
		INNER JOIN DS201808..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS201808..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS201808..PURMA AS PURMA ON MA001 = TC004
    GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS201810..PURTD
		INNER JOIN DS201810..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS201810..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS201810..PURMA AS PURMA ON MA001 = TC004
    GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
  HAVING TC011=@LOGINID AND TC014='Y' AND TD016='N'
END


ELSE


BEGIN
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS2010..PURTD
		INNER JOIN DS2010..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS2010..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS2010..PURMA AS PURMA ON MA001 = TC004
	GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS2018..PURTD
		INNER JOIN DS2018..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS2018..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS2018..PURMA AS PURMA ON MA001 = TC004
	GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS201803..PURTD
		INNER JOIN DS201803..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS201803..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS201803..PURMA AS PURMA ON MA001 = TC004
    GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS201805..PURTD
		INNER JOIN DS201805..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS201805..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS201805..PURMA AS PURMA ON MA001 = TC004
    GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS201808..PURTD
		INNER JOIN DS201808..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS201808..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS201808..PURMA AS PURMA ON MA001 = TC004
    GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
	UNION
	SELECT LEFT(TD012,6) AS TD012,TD004,MB002,MB003,TD009,CAST(SUM(TD008) AS INT) AS TD008,CAST(SUM(TD008-TD015) AS INT) AS SCMQUANTITY,TC014,TD016,TC011,TC004,MA002
	FROM DS201810..PURTD
		INNER JOIN DS201810..INVMB AS INVMB ON MB001 = TD004
		INNER JOIN DS201810..PURTC AS PURTC ON TC001 = TD001 AND TC002 = TD002
		 LEFT JOIN DS201810..PURMA AS PURMA ON MA001 = TC004
    GROUP BY LEFT(TD012,6),TD004,MB002,MB003,TD009,TC014,TD016,TC011,TC004,MA002
  HAVING TC011=@LOGINID AND TC004=@iSupplier AND TC014='Y' AND TD016='N'

END

END

